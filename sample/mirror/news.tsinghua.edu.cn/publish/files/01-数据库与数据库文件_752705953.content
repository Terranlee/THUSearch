01-数据库与数据库文件_752705953
* * SQL Server 2000 的物理存储 与索引结构 * * SQL Server 2000 的物理存储与索引结构 数据库与数据库文件 表的物理存储 索引及行操作 * * SQL Server 2000 的物理存储与索引结构 数据库 与 数据库文件 * * 认识SQL Server数据库 理论上讲，一个SQL Server可以包含多达32767个数据库； 理论上一个数据库最多可以包含231-1个对象（大于20亿）； 它可以横跨多个磁盘驱动器和多个操作系统文件； 它的大小可以从1MB到理论上的极限：1048516TB； * * 数据库与数据库文件 SQL Server系统数据库 SQL Server数据库文件 SQL Server数据库文件组 SQL Server数据库文件结构 数据库的备份与恢复 * * SQL Server系统数据库 Master数据库： 系统表：描述整个SQL Server的信息，如磁盘空间、文件分配、空间使用率、系统级的设置、登录帐户、其他数据库和其他的SQL Server； 每个用户数据库自身的系统表； Master数据库是SQL Server的核心！ * * SQL Server系统数据库 Model数据库： 模板数据库； 新创建的数据库从模板数据库继承内容：对象、权限等等。 * * SQL Server系统数据库 Tempdb数据库： 工作空间：临时表、中间结果、游标的实体化数据； Tempdb的日志只记录回滚事务的信息而没有恢复事务的信息，Why? 提高insert语句的性能！ 每次重启SQL Server时，Tempdb数据库被重新创建而不是恢复它。 * * SQL Server系统数据库 Pubs数据库： 样例数据库； 只占用2MB的空间。 * * SQL Server系统数据库 Northwind数据库： 样例数据库，最早是为Microsoft Access的用户开发的； 比Pubs数据库复杂一些； 占用4MB的空间。 * * SQL Server系统数据库 Msdb数据库： SQL Server Agent服务(SQL SERVER、DTC)使用的数据库； SQL Server Agent服务主要执行一些事先安排好的任务，如备份和复制； 一般不需要直接访问Msdb的表，和系统表一样，更不需要直接更新Msdb中的数据。 * * 数据库与数据库文件 一个数据库是由几个操作系统文件构成的？  数据库文件的空间是如何进行分配和管理的？ 数据库文件的结构是怎样的？ * * 基本知识 小型关系数据库管理系统： 每个关系(或对象)对应一个OS文件 文件结构简单，管理依赖于OS 如dBase、Foxbase等 大型关系数据库管理系统： 一个OS文件包含所有的对象，包括表 文件结构复杂，管理依赖于DBMS 如Oracle、DB2、Sybase、SQL Server等 * * SQL Server数据库文件 主数据文件简称主文件，*.MDF 一定要有一个且只能有一个 存放数据和索引及其他对象 还用来跟踪数据库的其他文件 次数据文件简称次文件，*.NDF 可以有0个或多个 存放主文件容纳不下的数据库对象 日志文件，*.LDF。至少要有一个 * * SQL Server数据库文件 每个数据库文件都有5个基本属性： 逻辑文件名：name 物理文件名：filename 初始大小：size，以页（8KB）为单位 最大尺寸：maxsize，以页为单位 扩展增量：growth 文件标识：fileid，在每个数据库内是唯一的，参阅sysfiles * * SQL Server数据库文件组 将一个数据库的多个数据文件归并到不同的文件组； 包含主数据文件的文件组叫做主文件组，每个数据库只能有一个主文件组； 除了主文件组以外，一个数据库也可以有一个或多个用户定义的文件组； 系统表的所有数据页总是从主文件组里的主文件中分配而来的。 * * SQL Server数据库文件组 缺省文件组： 每个文件组都有DEFAULT这个属性； 在每个数据库中，只能有一个文件组可以是缺省文件组。通常情况下主文件组也就是缺省文件组； 大多数SQL Server数据库都只有单独的一个数据文件在一个（缺省的主）文件组里。 * * 为什么要使用多个文件？ 使用位于同一物理驱动器的多个文件来创建一个数据库对该数据库的性能没有任何益处，但是： 根据备份恢复数据库时具有灵活性； 例如一个20GB的文件与4个5GB的文件 可以方便地将数据库移动到不同的驱动器上。 因为你会随时更新你的硬件配置 * * 创建SQL Server数据库举例 CREATE DATABASE Students ON PRIMARY (NAME = SP1_dat,  FILENAME = ‘c:\program files\Microsoft sql server\mssql\data\SP1dat.mdf’,  SIZE = 10, MAXSIZE = 50, FILEGROWTH  = 15%), (NAME = SP2_dat, ……………… ), FILEGROUP StudentsGroup1 (NAME = SGP1F1_dat,  FILENAME = ‘c:\program files\Microsoft sql server\mssql\data\SGP1F1dat.ndf’,  ……………… ), LOG ON (NAME = Students_log,  FILENAME = ‘c:\program files\Microsoft sql server\mssql\data\Students.ldf’,  SIZE = 5MB, MAXSIZE = 25MB, FILEGROWTH  = 5MB) * * SQL Server数据库文件结构 SQL Server绕没绕过OS的文件系统自己来管理数据库文件呢？ * * SQL Server数据库文件结构 用户数据库： 数据库由磁盘空间构成，磁盘空间被分配在一个或多个由DBMS管理的OS文件上； 数据库文件可以看成是逻辑页的序列，每页大小为8KB，从0到X连续编号； 可以用dbid+fileid+pageid来标识一页； Master数据库包含50个系统表，其中有19个和用户数据库的系统表一模一样。 举例： * * SQL Server数据库文件结构 Master中sysdatabases表的部分内容： * * SQL Server的空间分配与管理 SQL Server是以盘区(Extent)为单位来管理空间的； 一个盘区由8个逻辑上连续的页组成，或者说是64KB的空间； SQL Server 2000不会把整个盘区分配给只有少量数据的表，怎么办？ 统一盘区：只被单个对象拥有的盘区，盘区中的所有8个逻辑页只能被拥有它的对象使用； 混合盘区：最多被8个对象共享的盘区，即每个对象拥有盘区中的一页。 * * SQL Server的空间分配与管理 SQL Server的空间分配，对表或索引来说： 前8页：必须来自混合盘区； 8页之后：全部使用统一盘区。 盘区的管理： 全局分配映像页(GAM-Global Allocation Map) 在一个GAM所覆盖的范围内，每个盘区在GAM页内都有1个Bit与之对应。0表示已被使用，1表示空闲； 1个GAM页有8000Bytes，即64000Bits：4GB； 在一个数据库文件里每隔4GB的磁盘空间就会有一个GAM页存在。 * * SQL Server的空间分配与管理 盘区的管理： 共享全局分配映像页(SGAM - Shared Global Allocation Map) SGAM与GAM的覆盖范围相同：4GB； 在数据库文件里，每隔4GB的磁盘空间，SGAM和GAM页就会成对出现； 每个盘区在SGAM页内都有1个Bit与之对应。如果该位为1，则表明对应的盘区被用作混合盘区，而且该盘区还有空闲的页；如果该位为0，则表明相应的盘区没有被用作混合盘区，或者它是一个没有空闲页的混合盘区。  * * SQL Server的空间分配与管理 盘区的管理： * * SQL Server的空间分配与管理 盘区的管理： 在任何数据库文件里页0（即第一页）永远是文件头页，每个文件只能有一个文件头页； 页1（即第二页）是第一个PFS页，每隔8088页又是一个PFS页； 页2（即第三页）是第一个GAM页，页3（即第四页）是第一个SGAM页，每隔511230页就会出现另一个GAM页和SGAM页； 8000Bytes，64000Bits，64000*8=512000。 * * SQL Server的空间分配与管理 盘区的管理： 页空闲空间页(PFS – Page Free Space) 在数据库文件里，PFS页记录了每个单独的页是否已经被分配以及每一页上空闲空间的比例是多少，而GAM和SGAM页则是针对盘区的； 对每一页来说，在PFS页里都有一个Byte而不是一个Bit来记录该页是空、1-50%满、51-80%满、81-95%满还是96-100%满； 每个PFS页覆盖了8088个连续的页，几乎64MB的空间，因此每隔8088页又是一个PFS页； 数据库文件的第一个PFS页是页1。 * * SQL Server的空间分配与管理 盘区的管理： 索引分配映像页(IAM–Index Allocation Map) IAM页映射了由堆(Heap)或索引(Index)所使用的盘区，堆是一个没有簇集索引的表； 每个堆或索引都有一个或多个IAM页来记录所有分配给该对象的盘区； 对每个文件来说，如果一个堆或索引在该文件上有盘区，那么在该文件上这个堆或索引至少要有一个IAM页。如果一个堆或索引在一个文件上的盘区范围超过了一个IAM页能够记录的范围，那么这个堆或索引在该文件上就要有多个IAM页。  * * SQL Server的空间分配与管理 盘区的管理： IAM页的结构 一个小的页头：包含该IAM页映射范围内的第一个盘区的地址； 8个页指针槽：记录堆或索引的来自于混合盘区的前8页的页指针； 对一个对象来说只有它的第一个IAM页在这些页指针槽才有值，WHY？ 位映像：每个Bit代表了该IAM页映射范围内的一个盘区，而不管该盘区是否已经分配给拥有该IAM页的对象。值1表示已经分配给该对象，值0则相反； * * SQL Server的空间分配与管理 盘区的管理： IAM页的管理 SQL Server根据每个对象的需要来分配IAM页，IAM页在数据库文件中的位置是随机的； 每个IAM页覆盖了约512000页的范围，sysindexes表的FirstIAM字段指向了对象的第一个IAM页； 一个对象的所有IAM页被链接成链表：双向链表； 对于堆来说数据页和页中的数据行都没有任何特定的顺序，也没有被链接在一起，数据页之间的唯一逻辑关系记录在IAM页上：表明分配给某个堆的盘区(8页)；FirstIAM以及IAM页之间的双向链表。 * * SQL Server的空间分配与管理 盘区的管理： IAM页的问题 SQL Server指定每个堆和索引，包括簇集索引和非簇集索引，都有它们自己的IAM页。而具有簇集索引的表却没有自己的IAM页，WHY？ 答案：因为簇集索引的叶级页就是真正的…… * * SQL Server的空间分配与管理 盘区的管理： 用于备份和恢复数据库的特殊页 增量更新映射页(DCM-Differential Changed Map)，它用来记录自上一次全数据库备份以来，数据库文件中已被更新的盘区； 块更新映射页(BCM-Bulk Changed Map)，当数据库文件的一个盘区被用于最低级的或者是块日志操作时，BCM页中就会有记录； 数据库文件的第一个DCM和BCM页分别是页6和页7，像GAM和SGAM页一样，DCM和BCM页也用Bit来表示文件的每个盘区，每隔511230页它们就出现一次。  * * SQL Server数据库文件结构 * * 数据库的备份与恢复 备份类型 全备份：备份数据库中的每一页； 增量备份：只备份自上次全备份以来发生变化的盘区，DCM页； 日志备份：将自上次全备份或日志备份以来已经写到事务日志的所有日志记录拷贝下来。  恢复模式 FULL：对数据库的所有的操作都要记入日志，包括BULK操作； BULK_LOGGED：BULK操作只是简单地被记入日志，而利用BCM页里的信息来完整地恢复数据库； SIMPLE：事务日志以一定的时间间隔被截短。 